<!-- crow_app/templates/crow_app/test_webrtc.html -->
{% extends 'base.html' %}

{% block title %}Test WebRTC | Crow{% endblock %}

{% block content %}
<div class="container">
    <h1>ðŸŽ¥ Test WebRTC Video Calls</h1>
    <p>Test our new video calling feature. Open this page in two different browsers/tabs to test.</p>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card p-4">
                <h3>Quick Test Rooms</h3>
                <p>Click any room to join instantly:</p>
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <a href="{% url 'webrtc_video_room_str' 'test-room-1' %}" class="btn btn-primary">
                        Join Test Room 1
                    </a>
                    <a href="{% url 'webrtc_video_room_str' 'test-room-2' %}" class="btn btn-primary">
                        Join Test Room 2
                    </a>
                    <a href="{% url 'webrtc_video_room_str' 'test-room-3' %}" class="btn btn-primary">
                        Join Test Room 3
                    </a>
                </div>
                
                <h4>Or Create Custom Room</h4>
                <form id="customRoomForm" class="mt-3">
                    <div class="input-group">
                        <input type="text" id="roomName" class="form-control" placeholder="Enter room name">
                        <button type="submit" class="btn btn-success">Create & Join</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card p-4">
                <h3>How to Test:</h3>
                <ol class="mt-3">
                    <li>Click a room button above</li>
                    <li>Allow camera/microphone permissions when asked</li>
                    <li>Open another browser/tab or incognito window</li>
                    <li>Login with a different account (or create a test user)</li>
                    <li>Go to the same room URL</li>
                    <li>You should see video from both users!</li>
                </ol>
                
                <div class="alert alert-info mt-3">
                    <strong>Note:</strong> For local testing, both tabs need to be on same computer.
                    For testing between devices, use Ngrok or deploy online.
                </div>
                
                <h4>Existing Rooms</h4>
                {% if rooms %}
                    <ul class="list-group mt-2">
                        {% for room in rooms %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ room.name }}
                            <a href="{% url 'webrtc_video_room' room.id %}" class="btn btn-sm btn-outline-primary">
                                Join
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No rooms created yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="card mt-4 p-4">
        <h3>Troubleshooting</h3>
        <div class="row">
            <div class="col-md-6">
                <h5>Common Issues:</h5>
                <ul>
                    <li><strong>No video/audio:</strong> Check browser permissions</li>
                    <li><strong>Peers not connecting:</strong> Check browser console (F12)</li>
                    <li><strong>WebSocket errors:</strong> Make sure Django Channels is running</li>
                    <li><strong>Only one video shows:</strong> Refresh both tabs</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h5>Browser Requirements:</h5>
                <ul>
                    <li>Chrome, Firefox, Edge (latest versions)</li>
                    <li>HTTPS or localhost only</li>
                    <li>WebRTC support enabled</li>
                    <li>Camera/microphone access allowed</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Handle custom room creation
document.getElementById('customRoomForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const roomName = document.getElementById('roomName').value.trim();
    if (roomName) {
        // Convert to URL-friendly string
        const roomSlug = roomName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        window.location.href = `{% url 'webrtc_video_room_str' 'test' %}`.replace('test', roomSlug);
    }
});

// Check WebRTC support
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert('Your browser does not support WebRTC. Please use Chrome, Firefox, or Edge.');
}

// Check if user is logged in (should be, but just in case)

</script>

<style>
.card {
    border: 1px solid #dee2e6;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn {
    padding: 10px 20px;
    border-radius: 5px;
    font-weight: 500;
}

.list-group-item {
    border: 1px solid #dee2e6;
    margin-bottom: 5px;
    border-radius: 5px;
}

.alert {
    border-radius: 5px;
}

.input-group {
    margin-top: 10px;
}

.input-group .form-control {
    border-right: 0;
}

.input-group .btn {
    border-left: 0;
}
</style>
{% endblock %}