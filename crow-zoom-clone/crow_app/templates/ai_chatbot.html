{% extends "base.html" %}
{% load static %}

{% block title %}AI Assistant | Crow{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 flex items-center justify-center px-4 py-10">
    <div class="w-full max-w-4xl bg-white border border-gray-200 rounded-xl shadow-sm flex flex-col h-[80vh]">

        <!-- Header -->
        <div class="border-b border-gray-200 px-6 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-lg font-semibold text-gray-900">Crow AI Assistant</h1>
                <p class="text-sm text-gray-500">Intelligent meeting support</p>
            </div>
            <button onclick="clearChat()"
                    class="text-sm text-gray-500 hover:text-gray-800 transition">
                Clear
            </button>
        </div>

        <!-- Messages -->
        <div id="chatMessages"
             class="flex-1 overflow-y-auto px-6 py-6 space-y-6 bg-white">

            <div class="text-sm text-gray-600">
                <p class="font-medium text-gray-900 mb-2">
                    Welcome {% if user.is_authenticated %}{{ user.username }}{% else %}Guest{% endif %}
                </p>
                <p>
                    Ask anything about meetings, teams, scheduling, or general questions.
                </p>
            </div>

        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator"
             class="hidden px-6 py-3 text-sm text-gray-500 border-t border-gray-100">
            Assistant is typing...
        </div>

        <!-- Input -->
        <div class="border-t border-gray-200 px-6 py-4 bg-white">
            <div class="flex items-end gap-4">
                <textarea id="messageInput"
                          rows="1"
                          placeholder="Type your message..."
                          class="flex-1 resize-none border border-gray-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 transition"></textarea>

                <button id="sendButton"
                        onclick="sendMessage()"
                        class="bg-gray-900 text-white px-5 py-3 rounded-lg text-sm hover:bg-gray-800 transition">
                    Send
                </button>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');

messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = this.scrollHeight + 'px';
});

messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    addMessage(message, 'user');

    messageInput.value = '';
    messageInput.style.height = 'auto';
    messageInput.disabled = true;
    sendButton.disabled = true;

    showTyping();

    try {
        const response = await fetch('{% url "ai_chat_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ message })
        });

        const data = await response.json();

        hideTyping();

        if (response.ok) {
            addMessage(data.response, 'ai');
        } else {
            addMessage("An error occurred. Please try again.", 'ai');
        }

    } catch (err) {
        hideTyping();
        addMessage("Connection error. Please try again.", 'ai');
    }

    messageInput.disabled = false;
    sendButton.disabled = false;
    messageInput.focus();
}

function addMessage(text, sender) {
    const wrapper = document.createElement('div');
    wrapper.className = "flex " + (sender === 'user' ? "justify-end" : "justify-start");

    const bubble = document.createElement('div');
    bubble.className =
        "max-w-[75%] px-4 py-3 rounded-lg text-sm leading-relaxed " +
        (sender === 'user'
            ? "bg-gray-900 text-white"
            : "bg-gray-100 text-gray-800 border border-gray-200");

    bubble.innerText = text;

    wrapper.appendChild(bubble);
    chatMessages.appendChild(wrapper);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTyping() {
    typingIndicator.classList.remove('hidden');
}

function hideTyping() {
    typingIndicator.classList.add('hidden');
}

function clearChat() {
    chatMessages.innerHTML = "";
}

function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
