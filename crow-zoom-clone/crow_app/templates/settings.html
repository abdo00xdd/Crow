{% extends 'base.html' %}

{% block content %}
<div class="simple-card">
    <h3 class="mb-4">Settings</h3>
    
    <div class="row">
        <div class="col-md-3 mb-3 settings-sidebar">
            <div class="list-group">
                <a href="#profile" class="list-group-item list-group-item-action active">Profile</a>
                <a href="#account" class="list-group-item list-group-item-action">Account</a>
                <a href="#privacy" class="list-group-item list-group-item-action">Privacy</a>
                <a href="#notifications" class="list-group-item list-group-item-action">Notifications</a>
            </div>
        </div>
        
        <div class="col-md-9 settings-content">
            <form method="post" enctype="multipart/form-data" class="settings-form">
                {% csrf_token %}
                <div id="profile" class="mb-4">
                    <h5 class="mb-3">Profile</h5>
                    <div class="row">
                        <div class="col-md-4 text-center">
                            {% if profile.profile_picture %}
                                <img src="{{ profile.profile_picture.url }}" alt="{{ user.username }}" class="rounded-lg mb-2" style="width:120px; height:120px; object-fit:cover;" />
                            {% else %}
                                <div class="user-avatar rounded-lg mb-2" style="width:120px;height:120px;font-size:2rem;display:flex;align-items:center;justify-content:center;">{{ user.username|first|upper }}</div>
                            {% endif %}
                            <div class="mt-2">
                                <input type="file" name="profile_picture" accept="image/*" />
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">First Name</label>
                                <input name="first_name" type="text" class="form-control" value="{{ user.first_name }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Last Name</label>
                                <input name="last_name" type="text" class="form-control" value="{{ user.last_name }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Bio</label>
                                <textarea name="bio" class="form-control" rows="3">{{ profile.bio }}</textarea>
                            </div>
                            <!-- timezone removed to simplify settings -->
                        </div>
                    </div>
                </div>
                <div id="account" class="mb-4">
                    <h5 class="mb-3">Account</h5>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input name="email" type="email" class="form-control" value="{{ user.email }}">
                    </div>
                </div>

                <!-- privacy simplified/removed -->

                <div id="notifications" class="mb-4">
                    <h5 class="mb-3">Meeting Preferences</h5>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="default_join_with_video" name="default_join_with_video" {% if profile.default_join_with_video %}checked{% endif %}>
                        <label class="form-check-label" for="default_join_with_video">Join with video on by default</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="default_mute_on_join" name="default_mute_on_join" {% if profile.default_mute_on_join %}checked{% endif %}>
                        <label class="form-check-label" for="default_mute_on_join">Mute on join by default</label>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <a href="{% url 'home' %}" class="btn btn-outline-secondary">Cancel</a>
                </div>
            </form>
                </div>
    </div>
</div>
<script>
    // Highlight active sidebar link on click and scroll
    (function(){
        const links = Array.from(document.querySelectorAll('.settings-sidebar .list-group-item'));
        const sections = links.map(l => document.querySelector(l.getAttribute('href'))).filter(Boolean);

        function setActive(link){
            links.forEach(l=>l.classList.remove('active'));
            link.classList.add('active');
        }

        links.forEach(link=>{
            link.addEventListener('click', function(e){
                // smooth scroll
                const target = document.querySelector(this.getAttribute('href'));
                if(target){
                    e.preventDefault();
                    target.scrollIntoView({behavior:'smooth', block:'start'});
                    setActive(this);
                }
            });
        });

        window.addEventListener('scroll', function(){
            const offset = window.scrollY + 120;
            for(let i=sections.length-1;i>=0;i--){
                const sec = sections[i];
                if(sec && sec.offsetTop <= offset){
                    const href = '#'+sec.id;
                    const link = links.find(l=>l.getAttribute('href')===href);
                    if(link) setActive(link);
                    break;
                }
            }
        });
    })();
</script>
{% endblock %}